<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Using packets - CrSFML Tutorials</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link href="../codehilite.css" rel="stylesheet" />
  <link href="../style.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Using packets";
    var mkdocs_page_input_path = "network/packet.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> CrSFML Tutorials</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <p class="caption"><span class="caption-text">System module</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../system/time.html">Handling time</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../system/thread.html">Threads</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../system/stream.html">User data streams</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Window module</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../window/window.html">Opening and managing an SFML window</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../window/events.html">Events explained</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../window/inputs.html">Keyboard, mouse and joysticks</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../window/opengl.html">Using OpenGL in an SFML window</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Graphics module</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../graphics/draw.html">Drawing 2D stuff</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../graphics/sprite.html">Sprites and textures</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../graphics/text.html">Text and fonts</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../graphics/shape.html">Shapes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../graphics/vertex-array.html">Designing your own entities with vertex arrays</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../graphics/transform.html">Position, rotation, scale: transforming entities</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../graphics/shader.html">Adding special effects with shaders</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../graphics/view.html">Controlling the 2D camera with views</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Audio module</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../audio/sounds.html">Playing sounds and music</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../audio/recording.html">Recording audio</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../audio/streams.html">Custom audio streams</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../audio/spatialization.html">Spatialization: Sounds in 3D</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Network module</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="socket.html">Communication using sockets</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="packet.html">Using packets</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#problems-that-need-to-be-solved">Problems that need to be solved</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#packets">Packets</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#extending-packets-to-handle-user-types">Extending packets to handle user types</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="http.html">Web requests with HTTP</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="ftp.html">File transfers with FTP</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">CrSFML Tutorials</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Network module &raquo;</li>
        
      
    
    <li>Using packets</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/oprypin/crsfml/blob/tutorials/network/packet.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="using-packets">Using packets</h1>
<h2 id="problems-that-need-to-be-solved">Problems that need to be solved</h2>
<p>Exchanging data on a network is more tricky than it seems. The reason is that different machines, with different operating systems and processors, can be involved. Several problems arise if you want to exchange data reliably between these different machines.</p>
<p>The first problem is the endianness. The endianness is the order in which a particular processor interprets the bytes of primitive types that occupy more than a single byte (integers and floating point numbers). There are two main families: "big endian" processors, which store the most significant byte first, and "little endian" processors, which store the least significant byte first. There are other, more exotic byte orders, but you'll probably never have to deal with them.<br />
The problem is obvious: If you send a variable between two computers whose endianness doesn't match, they won't see the same value. For example, the 16-bit integer "42" in big endian notation is 00000000 00101010, but if you send this to a little endian machine, it will be interpreted as "10752".</p>
<p>The second problem is specific to how the TCP protocol works. Because it doesn't preserve message boundaries, and can split or combine chunks of data, receivers must properly reconstruct incoming messages before interpreting them. Otherwise bad things might happen, like reading incomplete variables, or ignoring useful bytes.</p>
<p>You may of course face other problems with network programming, but these are the lowest-level ones, that almost everybody will have to solve. This is the reason why SFML provides some simple tools to avoid them.</p>
<h2 id="packets">Packets</h2>
<p>The two problems (endianness and message boundaries) are solved by using a specific class to pack your data: <a href="http://oprypin.github.io/crsfml/api/SF/Packet.html">Packet</a>. As a bonus, it provides a much nicer interface than plain old byte arrays.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># on sending side</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">10_u16</span>
<span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span>
<span class="n">d</span> <span class="o">=</span> <span class="mf">0.6_f64</span>

<span class="n">packet</span> <span class="o">=</span> <span class="no">SF</span><span class="o">::</span><span class="n">Packet</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">packet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">packet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">packet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="c1"># on receiving side</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">UInt16</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">Float64</span><span class="p">)</span>
<span class="bp">pp</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span>
</code></pre></div>


<p>Unlike writing, reading from a packet can fail if you try to extract more bytes than the packet contains. If a reading operation fails, the packet error flag is set. To check the error flag of a packet, use the <code>valid?</code> method:</p>
<div class="codehilite"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">Int32</span><span class="p">)</span>
<span class="k">unless</span> <span class="n">packet</span><span class="o">.</span><span class="n">valid?</span>
  <span class="c1"># error</span>
<span class="k">end</span>
</code></pre></div>


<p>Sending and receiving packets is as easy as sending/receiving an array of bytes: sockets have <code>send</code> and <code>receive</code> methods that directly accept a <a href="http://oprypin.github.io/crsfml/api/SF/Packet.html">Packet</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># with a TCP socket</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">tcp_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>

<span class="n">packet</span> <span class="o">=</span> <span class="no">SF</span><span class="o">::</span><span class="n">Packet</span><span class="o">.</span><span class="n">new</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">tcp_socket</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="c1"># with a UDP socket</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">udp_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">recipient_address</span><span class="p">,</span> <span class="n">recipient_port</span><span class="p">)</span>

<span class="n">packet</span> <span class="o">=</span> <span class="no">SF</span><span class="o">::</span><span class="n">Packet</span><span class="o">.</span><span class="n">new</span>
<span class="n">status</span><span class="p">,</span> <span class="n">sender_address</span><span class="p">,</span> <span class="n">sender_port</span> <span class="o">=</span> <span class="n">udp_socket</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
</code></pre></div>


<p>Packets solve the "message boundaries" problem, which means that when you send a packet on a TCP socket, you receive the exact same packet on the other end, it cannot contain less bytes, or bytes from the next packet that you send. However, it has a slight drawback: To preserve message boundaries, <a href="http://oprypin.github.io/crsfml/api/SF/Packet.html">Packet</a> has to send some extra bytes along with your data, which implies that you can only receive them with a <a href="http://oprypin.github.io/crsfml/api/SF/Packet.html">Packet</a> if you want them to be properly decoded. Simply put, you can't send an SFML packet to a non-SFML packet recipient, it has to use an SFML packet for receiving too. Note that this applies to TCP only, UDP is fine since the protocol itself preserves message boundaries.</p>
<h2 id="extending-packets-to-handle-user-types">Extending packets to handle user types</h2>
<p>Packets have overloads of their methods for the most common primitive types and the most common standard types, but what about your own classes? It is easy to subclass or reopen <a href="http://oprypin.github.io/crsfml/api/SF/Packet.html">Packet</a> and add your own overloads.</p>
<div class="codehilite"><pre><span></span><code><span class="bp">record</span> <span class="n">Character</span><span class="p">,</span> <span class="n">age</span> <span class="p">:</span> <span class="nb">UInt8</span><span class="p">,</span> <span class="n">name</span> <span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">weight</span> <span class="p">:</span> <span class="nb">Float32</span>

<span class="k">class</span> <span class="nn">SF::</span><span class="nc">Packet</span>
  <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">c</span> <span class="p">:</span> <span class="n">Character</span><span class="p">)</span>
    <span class="n">write</span> <span class="n">c</span><span class="o">.</span><span class="n">age</span>
    <span class="n">write</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span>
    <span class="n">write</span> <span class="n">c</span><span class="o">.</span><span class="n">weight</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="k">type</span> <span class="p">:</span> <span class="n">Character</span><span class="o">.</span><span class="n">class</span><span class="p">)</span> <span class="p">:</span> <span class="n">Character</span>
    <span class="n">Character</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="nb">UInt8</span><span class="p">),</span> <span class="n">read</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span> <span class="n">read</span><span class="p">(</span><span class="nb">Float32</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>


<p>Now that these methods are defined, you can insert/extract a <code>Character</code> instance to/from a packet like any other primitive type:</p>
<div class="codehilite"><pre><span></span><code><span class="n">bob</span> <span class="o">=</span> <span class="n">Character</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">65_u8</span><span class="p">,</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="mf">12.34_f32</span><span class="p">)</span>

<span class="n">packet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bob</span><span class="p">)</span>
<span class="n">packet</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">Character</span><span class="p">)</span>
</code></pre></div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="http.html" class="btn btn-neutral float-right" title="Web requests with HTTP">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="socket.html" class="btn btn-neutral" title="Communication using sockets"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/oprypin/crsfml/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="socket.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="http.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
